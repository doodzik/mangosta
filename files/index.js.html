<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>index.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Factory.html">Factory</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: index.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var Factory, strgMethods;
strgMethods = require(&#x27;strg_methods&#x27;);

/**
@class Factory
@example
  new Factory(mongoose.model(&#x27;name&#x27;), function() { return obj; });
@constructor
@param [model] {Object} The mongoose.model(&#x27;name&#x27;) or nothing if you want a plain factory Object
@param factory {Function} The factory Object
  @param factory.object {Object} The return Object of function, if you want you can include another factory in the obj/child. please look at the test/index.js ile in the repo how it is included
    @param [factory.object.key] {String|Number|Array} value 
    @param [factory.object.$child] {Object} you can nest children in other children as you wish. you can use empty children, too
    @param [factory.object.$child.child_name] {Object|Function}
@property model
@type Function|Object
@default factory
@property factory
@type Function
@property sequence
@type Number
@default 0
*/
function Factory(model, factory){
  this.model = model;
  this.factory = factory || model;
  this.sequenc = 0;
}

/**

builds a mongoose Object or a plain Object

@method build
@async
@param [options={}] {Object} options field, if nothing specified then return one default doc
  @param [options.$factory=&quot;default&quot;] {String} write the child factories down seperated by space which you want to build. $child{first: {$child: second{}}} would be options.$factory = &quot;first second&quot;
  @param [options.$seq=this.sequenc] {Number} when provided resets sequence with given num
  @param [options.$doc={}] {Object} Set the value of the doc to create
    @param [options.$doc.$factory=options.$factory] {String} same as options.$factory
    @param [options.$doc.$num=1] {Number} set number of docs which should be created
    @param [options.$doc.key] {String|Number|Array} value which should be merged with parent factory and this factory
  @param [options.$docs=[{}]] {Array} if you want to build multiple different docs, basically the same as options.$doc in an Array -&gt; [ options.$doc, options.$doc ]
@param callback {Function} callback
*/
Factory.prototype.build = function (options, callback){
  if (typeof options == &quot;function&quot;){
    callback = options;
    options = {};
  }
  this.sequenc = (typeof options.$seq === &#x27;undefined&#x27;) ? this.sequenc : options.$seq;
  this._getNewDocs(options, function (err, docs) {
    if (err) { return callback(err, null); }
    docs = (docs.length === 1 ) ? docs[0] : docs;
    return callback(err, docs);
  });
};

/**

checks if new mongoose.model(object) got a wrong field value

@method _compareObjSync
@private
@param mObj {Object} mongoose Object
@param obj {Object} plain Object
@return {Object} if no error then false else new Error
*/
Factory.prototype._compareObjSync = function (mObj, obj) {
  if(this.model === this.factory){ return false; }
  obj._id = &quot;&quot;;
  mObj = Object.keys(mObj.toObject()).sort();
  obj = Object.keys(obj).sort();
  for (var i = 0; i &lt; mObj.length; i++) {
    if (mObj[i] != obj[i]) {
      return new Error(obj[i]+&#x27; isnt the right Schema var type&#x27;);
    }
  }
  return false;
};

/**

merges obj2 into obj1

@method _mergeObjsSync
@private
@param obj1 {Object} Object
@param obj2 {Object} Object
@return {Object} merged object
*/
Factory.prototype._mergeObjsSync = function (obj1, obj2) {
  var attrname, obj3;
  obj3 = {};
  for (attrname in obj1) {
    obj3[attrname] = obj1[attrname];
  }
  for (attrname in obj2) {
    obj3[attrname] = obj2[attrname];
  }
  return obj3;
};

/**

handles the options field from build

@method _getNewDocs
@private
@async
@param options {Object} options field
@param callback {Function} callback
@returns {Function} callback(err, docs) 
*/
Factory.prototype._getNewDocs = function (options, callback) {
  var $doc, docs, $docsOpt, factory, $num, _i, _len;
  docs = [];
  options.$docs = (options.$doc) ? [options.$doc] : options.$docs;
  $docsOpt = options.$docs || [{}];
  for (_i = 0, _len = $docsOpt.length; _i &lt; _len; _i++) {
    $doc = $docsOpt[_i];
    $num = $doc.$num || 1;
    factory = (typeof $doc.$factory === &quot;undefined&quot;) ? options.$factory : $doc.$factory;
    this._getFactory(factory, function(err, $fctry) {
      if (err) {return callback(err, null);}
      $factory = $fctry;
    });
    delete $doc.$factory;
    delete $doc.$num;
    for (__i = 0, __len = $num; __i &lt; __len; __i++) {
      this.sequenc++;
      docs.push(this._newDoc($factory, $doc));
      err = this._compareObjSync(docs[_i], this._mergeObjsSync($factory, $doc));
    }
  }
  return callback(err, docs);
}; 

/**

get factory object

@method _getFactory
@private
@async
@param options {Object} options field
@param callback {Function} callback
@returns {Function} callback(err, factoryObject) 
*/
Factory.prototype._getFactory = function (options, callback){
  var factory, err, child, _len, _i, child_factory;
  if (typeof options == &quot;function&quot;){
    callback = options;
    options = &quot;&quot;;
  }
  factory = this.factory();
  child = factory.$child;
  delete factory.$child;
  if(options &amp;&amp; options != &quot;default&quot;){
    factories = options.split(&#x27; &#x27;);
    for (_i = 0, _len = factories.length; _i &lt; _len; _i++) {
      child_factory = child[factories[_i]];
      if (typeof child_factory === &quot;undefined&quot;) { return callback(new Error(factories[_i]+&#x27; isnt a child factory&#x27;), null); }
      child_factory = (typeof child_factory === &#x27;function&#x27;) ? child_factory() : child_factory;
      child = child_factory.$child;
      delete child_factory.$child;
      factory = this._mergeObjsSync(factory, child_factory);
    }
  }
  return callback(err, factory);
};

/**

set new doc

@method _newDoc
@private
@param [options={}] {Object} options field
@param callback {Function} callback
@return {Object} mongoose factory ? mongoose Object : plain Object 
*/
Factory.prototype._newDoc = function (factory, doc){
  if(this.model === this.factory){
    return this.stringMethods(this._mergeObjsSync(factory, doc));
  } else {
    return new this.model(this.stringMethods(this._mergeObjsSync(factory, doc)));
  }
};

/**

applies strMethods.all() to each value of object

@method stringMethods
@uses strgMethods
@private
@param doc {Object} takes a document
@return {Object} object with applied strgMethods
*/
Factory.prototype.stringMethods = function (doc){
  for (var key in doc) {
    if (doc.hasOwnProperty(key)) {
      Strg = new strgMethods(doc[key], this.sequenc);
      doc[key] = Strg.all();
    }
  }
  return doc;
};

/** 

accepts options as factory.build

@example
  //with mocha you can pass done() as a callback
  factory.create({$doc: {$num: 3}}, done());
  factory.create(function(err, docs){
    //insert here whatever you want
  });

@method create
@async
@param [options={}] {Object} options field
@param [callback] {Function} callback
@return {Function} with (err, docs)
*/
Factory.prototype.create = function (options, callback) {
  if(this.model === this.factory){ throw new Error(&quot;you cant use a mongoose method on a plain factory object&quot;); }
  if (typeof options == &quot;function&quot;){
    callback = options;
    options = {};
  } else if (typeof options == &quot;undefined&quot;){
    options = {};
  }
  this.build(options, function (err, docs) {
    if (err &amp;&amp; typeof callback == &quot;function&quot;) { return callback(err, null); }
    this.model.create(docs, function (err, docs){
      if (typeof callback == &quot;function&quot;){
        return callback(err, docs);
      }
    });
  });
};

/**

instead of factory.model.find
see http://mongoosejs.com/docs/api.html#model_Model.find

@method find
@uses mongoose.model.find
*/
Factory.prototype.find =  function (args) {
  if(this.model === this.factory){ throw new Error(&quot;you cant use a mongoose method on a plain factory object&quot;); }
  this.model.find.call(arguments);
};

/**

instead of factory.model.count
see http://mongoosejs.com/docs/api.html#model_Model.count

@method count
@uses mongoose.model.count
*/
Factory.prototype.count =  function (args) {
  if(this.model === this.factory){ throw new Error(&quot;you cant use a mongoose method on a plain factory object&quot;); }
  this.model.count.call(arguments);
};

/** 

instead of factory.model.findOne
see http://mongoosejs.com/docs/api.html#model_Model.findOne

@method findOne
@uses mongoose.model.findOne
*/
Factory.prototype.findOne = function (args) {
  if(this.model === this.factory){ throw new Error(&quot;you cant use a mongoose method on a plain factory object&quot;); }
  this.model.findOne.call(arguments);
};

/**

removes docs which matches options from factory.model

@method remove
@async
@uses mongoose.model.remove
@param [options={}] options field as in mongoose.model.remove
@param [callback] {Function} callback
@return {Function} returns the same callback as http://mongoosejs.com/docs/api.html#model_Model.remove
*/
Factory.prototype.remove = function (options, callback) {
  if(this.model === this.factory){ throw new Error(&quot;you cant use a mongoose method on a plain factory object&quot;); }
  if (typeof options == &quot;undefined&quot;) {
    options = {};
  }
  if (typeof options == &quot;function&quot;) {
    callback = options;
    options = {};
  }
  this.model.remove(options, function (err, num){
    if (typeof callback != &quot;undefined&quot;) {
      callback(err, num);
    }
  });
};

module.exports = Factory;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
